<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - MikroTik Portal</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
        }
        
        .admin-title {
            font-size: 2rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .admin-nav {
            display: flex;
            gap: 20px;
        }
        
        .nav-btn {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .nav-btn:hover {
            background: #2980b9;
        }
        
        .nav-btn.active {
            background: #2c3e50;
        }
        
        .admin-content {
            display: none;
        }
        
        .admin-content.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .users-table {
            width: 100%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .users-table th,
        .users-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }
        
        .users-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .users-table tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 0.8rem;
        }
        
        .btn-edit {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .search-bar {
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 3px;
        }
        
        .page-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Admin Header -->
        <div class="admin-header">
            <h1 class="admin-title">
                <i class="fas fa-cogs"></i>
                Admin Dashboard
            </h1>
            <div class="admin-nav">
                <button class="nav-btn active" data-tab="dashboard">
                    <i class="fas fa-chart-bar"></i>
                    Dashboard
                </button>
                <button class="nav-btn" data-tab="users">
                    <i class="fas fa-users"></i>
                    Users
                </button>
                <button class="nav-btn" data-tab="sessions">
                    <i class="fas fa-clock"></i>
                    Sessions
                </button>
                <button class="nav-btn" data-tab="reports">
                    <i class="fas fa-file-alt"></i>
                    Reports
                </button>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div class="admin-content active" id="dashboard-tab">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-users">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-users">0</div>
                    <div class="stat-label">Active Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-sessions">0</div>
                    <div class="stat-label">Active Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-sessions">0</div>
                    <div class="stat-label">Total Sessions</div>
                </div>
            </div>
            
            <div class="stat-card">
                <h3>Recent Activity</h3>
                <div id="recent-activity">
                    <p>Loading recent activity...</p>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div class="admin-content" id="users-tab">
            <div class="search-bar">
                <input type="text" class="search-input" id="user-search" placeholder="Search users...">
            </div>
            
            <table class="users-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Company</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Last Login</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="users-table-body">
                    <tr>
                        <td colspan="7">Loading users...</td>
                    </tr>
                </tbody>
            </table>
            
            <div class="pagination" id="users-pagination">
                <!-- Pagination will be generated here -->
            </div>
        </div>

        <!-- Sessions Tab -->
        <div class="admin-content" id="sessions-tab">
            <div class="search-bar">
                <input type="text" class="search-input" id="session-search" placeholder="Search sessions...">
            </div>
            
            <table class="users-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>IP Address</th>
                        <th>MAC Address</th>
                        <th>Start Time</th>
                        <th>End Time</th>
                        <th>Duration</th>
                        <th>Data Usage</th>
                    </tr>
                </thead>
                <tbody id="sessions-table-body">
                    <tr>
                        <td colspan="7">Loading sessions...</td>
                    </tr>
                </tbody>
            </table>
            
            <div class="pagination" id="sessions-pagination">
                <!-- Pagination will be generated here -->
            </div>
        </div>

        <!-- Reports Tab -->
        <div class="admin-content" id="reports-tab">
            <div class="stat-card">
                <h3>Generate Reports</h3>
                <p>Download various reports in CSV format:</p>
                
                <div style="margin-top: 20px;">
                    <button class="nav-btn" onclick="downloadReport('users')">
                        <i class="fas fa-download"></i>
                        Download Users Report
                    </button>
                    
                    <button class="nav-btn" onclick="downloadReport('sessions')">
                        <i class="fas fa-download"></i>
                        Download Sessions Report
                    </button>
                    
                    <button class="nav-btn" onclick="downloadReport('stats')">
                        <i class="fas fa-download"></i>
                        Download Statistics Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Admin Dashboard JavaScript
        const API_BASE = '/api';
        const ADMIN_TOKEN = localStorage.getItem('admin_token') || prompt('Enter admin token:');
        
        if (ADMIN_TOKEN) {
            localStorage.setItem('admin_token', ADMIN_TOKEN);
        }

        // Tab navigation
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                
                // Update active tab button
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Update active content
                document.querySelectorAll('.admin-content').forEach(content => content.classList.remove('active'));
                document.getElementById(`${tab}-tab`).classList.add('active');
                
                // Load tab data
                loadTabData(tab);
            });
        });

        // Load data for specific tab
        function loadTabData(tab) {
            switch(tab) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'users':
                    loadUsersData();
                    break;
                case 'sessions':
                    loadSessionsData();
                    break;
            }
        }

        // Load dashboard statistics
        async function loadDashboardData() {
            try {
                const response = await fetch(`${API_BASE}/admin/stats`, {
                    headers: {
                        'X-Admin-Token': ADMIN_TOKEN
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById('total-users').textContent = data.userStats?.total_users || 0;
                    document.getElementById('active-users').textContent = data.userStats?.active_users || 0;
                    document.getElementById('active-sessions').textContent = data.sessionStats?.active_sessions || 0;
                    document.getElementById('total-sessions').textContent = data.sessionStats?.total_sessions || 0;
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Load users data
        async function loadUsersData(page = 1) {
            try {
                const response = await fetch(`${API_BASE}/admin/users?page=${page}&limit=20`, {
                    headers: {
                        'X-Admin-Token': ADMIN_TOKEN
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayUsers(data.users);
                    displayPagination(data.pagination, 'users');
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Display users in table
        function displayUsers(users) {
            const tbody = document.getElementById('users-table-body');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">No users found</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>${user.company_name}</td>
                    <td>
                        <span class="status-badge ${user.is_active ? 'status-active' : 'status-inactive'}">
                            ${user.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>${user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'}</td>
                    <td>
                        <button class="action-btn btn-edit" onclick="editUser('${user.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn btn-delete" onclick="deleteUser('${user.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Load sessions data
        async function loadSessionsData(page = 1) {
            try {
                const response = await fetch(`${API_BASE}/admin/sessions?page=${page}&limit=20`, {
                    headers: {
                        'X-Admin-Token': ADMIN_TOKEN
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displaySessions(data.sessions);
                    displayPagination(data.pagination, 'sessions');
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        // Display sessions in table
        function displaySessions(sessions) {
            const tbody = document.getElementById('sessions-table-body');
            
            if (sessions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">No sessions found</td></tr>';
                return;
            }
            
            tbody.innerHTML = sessions.map(session => `
                <tr>
                    <td>${session.username}</td>
                    <td>${session.ip_address}</td>
                    <td>${session.mac_address || 'N/A'}</td>
                    <td>${new Date(session.session_start).toLocaleString()}</td>
                    <td>${session.session_end ? new Date(session.session_end).toLocaleString() : 'Active'}</td>
                    <td>${session.duration ? formatDuration(session.duration) : 'N/A'}</td>
                    <td>${formatBytes(session.bytes_in + session.bytes_out)}</td>
                </tr>
            `).join('');
        }

        // Display pagination
        function displayPagination(pagination, type) {
            const container = document.getElementById(`${type}-pagination`);
            
            if (!pagination || pagination.pages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            
            if (pagination.page > 1) {
                html += `<button class="page-btn" onclick="load${type.charAt(0).toUpperCase() + type.slice(1)}Data(${pagination.page - 1})">Previous</button>`;
            }
            
            for (let i = 1; i <= pagination.pages; i++) {
                if (i === pagination.page) {
                    html += `<button class="page-btn active">${i}</button>`;
                } else {
                    html += `<button class="page-btn" onclick="load${type.charAt(0).toUpperCase() + type.slice(1)}Data(${i})">${i}</button>`;
                }
            }
            
            if (pagination.page < pagination.pages) {
                html += `<button class="page-btn" onclick="load${type.charAt(0).toUpperCase() + type.slice(1)}Data(${pagination.page + 1})">Next</button>`;
            }
            
            container.innerHTML = html;
        }

        // Download reports
        async function downloadReport(type) {
            try {
                const response = await fetch(`${API_BASE}/admin/reports/${type}`, {
                    headers: {
                        'X-Admin-Token': ADMIN_TOKEN
                    }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${type}_report_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                }
            } catch (error) {
                console.error('Error downloading report:', error);
                alert('Error downloading report');
            }
        }

        // Utility functions
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Search functionality
        document.getElementById('user-search').addEventListener('input', (e) => {
            // Implement user search
        });

        document.getElementById('session-search').addEventListener('input', (e) => {
            // Implement session search
        });

        // Load initial data
        loadDashboardData();
    </script>
</body>
</html>
